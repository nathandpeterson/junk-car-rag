# Multimodal RAG Architecture Design Plan

- Generated by Claude after describing the project

## 🏗️ System Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                        INPUT SOURCES                            │
├─────────────────────────────────────────────────────────────────┤
│  📄 Web Rules    │  🖼️  Inspection PDF   │  📋 Checklists        │
│  (accordion)     │  (diagrams)           │  (safety items)      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      EXTRACTORS/                                │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
│  │ WebRuleExtractor│ │DiagramExtractor │ │ChecklistExtract.│   │
│  │                 │ │                 │ │                 │   │
│  │ • Scrapes web   │ │ • Extracts imgs │ │ • Parses lists  │   │
│  │ • Handles JS    │ │ • OCR text      │ │ • Item mapping  │   │
│  │ • Rule parsing  │ │ • Context assoc │ │ • Categories    │   │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    PARSED CONTENT STORE                         │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
│  │   Raw Rules     │ │  Raw Diagrams   │ │ Raw Checklists  │   │
│  │                 │ │                 │ │                 │   │
│  │ • JSON metadata │ │ • Image files   │ │ • JSON items    │   │
│  │ • Full text     │ │ • Descriptions  │ │ • Categories    │   │
│  │ • Structure     │ │ • Topics        │ │ • Requirements  │   │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CHUNKING STRATEGIES                          │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
│  │ RuleChunker     │ │ VisualChunker   │ │ChecklistChunker │   │
│  │                 │ │                 │ │                 │   │
│  │ • Rule-level    │ │ • Image + desc  │ │ • Item-level    │   │
│  │ • Hierarchy     │ │ • Topic-based   │ │ • Category      │   │
│  │ • Cross-refs    │ │ • Context       │ │ • Dependencies  │   │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   UNIFIED CHUNK STORE                           │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    ChunkManager                             │ │
│  │  • Unified chunk format                                     │ │
│  │  • Content type metadata                                    │ │
│  │  • Cross-references between chunks                          │ │
│  │  • Version management                                       │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    EMBEDDING GENERATION                         │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                  EmbeddingEngine                            │ │
│  │  • Text embeddings (sentence-transformers)                 │ │
│  │  • Image embeddings (CLIP/similar)                         │ │
│  │  • Metadata embeddings                                     │ │
│  │  • Hybrid search indices                                   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    RETRIEVAL SYSTEM                             │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                 MultimodalRetriever                         │ │
│  │  • Semantic search (text/images)                           │ │
│  │  • Keyword filtering                                       │ │
│  │  • Content type filtering                                  │ │
│  │  • Rule hierarchy traversal                                │ │
│  │  • Cross-reference expansion                               │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    RESPONSE GENERATION                          │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │               VirtualInspector                              │ │
│  │  • LLM integration (multiple providers)                    │ │
│  │  • Multimodal response formatting                          │ │
│  │  • Citation generation                                     │ │
│  │  • Image/diagram inclusion                                 │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 Key Design Principles

### 1. **Separation of Concerns**

- **Extraction**: Get raw content from sources
- **Parsing**: Structure the raw content
- **Chunking**: Create retrieval-optimized pieces
- **Embedding**: Generate searchable vectors
- **Retrieval**: Find relevant content
- **Generation**: Create final responses

### 2. **Pluggable Components**

Each stage has interchangeable implementations:

- Different extractors for different sources
- Different chunking strategies for different content types
- Different embedding models
- Different LLM providers

### 3. **Unified Data Model**

All content types flow through the same pipeline with consistent interfaces.

## 📂 Proposed Directory Structure

```
lemons_rag/
├── extractors/
│   ├── __init__.py
│   ├── base.py              # AbstractExtractor
│   ├── web_rules.py         # WebRuleExtractor
│   ├── diagram_pdf.py       # DiagramExtractor
│   └── checklist.py         # ChecklistExtractor
├── chunkers/
│   ├── __init__.py
│   ├── base.py              # AbstractChunker
│   ├── rule_chunker.py      # RuleChunker
│   ├── visual_chunker.py    # VisualChunker
│   └── checklist_chunker.py # ChecklistChunker
├── embeddings/
│   ├── __init__.py
│   ├── text_embeddings.py   # TextEmbedder
│   ├── image_embeddings.py  # ImageEmbedder
│   └── embedding_manager.py # EmbeddingManager
├── retrieval/
│   ├── __init__.py
│   ├── multimodal_search.py # MultimodalRetriever
│   ├── filters.py           # ContentFilters
│   └── rankers.py           # ResultRankers
├── generation/
│   ├── __init__.py
│   ├── model_providers.py   # LLM providers
│   ├── prompt_templates.py  # Prompt management
│   └── response_formatter.py # Response formatting
├── data/
│   ├── raw/                 # Raw extracted content
│   │   ├── rules/
│   │   ├── diagrams/
│   │   └── checklists/
│   ├── chunks/              # Processed chunks
│   └── embeddings/          # Vector indices
├── core/
│   ├── __init__.py
│   ├── chunk_manager.py     # ChunkManager
│   ├── content_types.py     # Content type definitions
│   └── config.py            # Configuration
├── cli/
│   ├── __init__.py
│   ├── extract.py           # Extraction commands
│   ├── process.py           # Processing commands
│   └── query.py             # Query interface
└── main.py                  # Main CLI entry point
```

## 🔧 Core Abstractions

### 1. **Content Types**

```python
@dataclass
class ContentChunk:
    chunk_id: str
    content_type: ContentType  # RULE, DIAGRAM, CHECKLIST
    title: str
    content: str
    metadata: Dict[str, Any]
    embeddings: Optional[Dict[str, np.ndarray]]

class ContentType(Enum):
    RULE = "rule"
    DIAGRAM = "diagram"
    CHECKLIST = "checklist"
    CROSS_REFERENCE = "cross_reference"
```

### 2. **Extractor Interface**

```python
class AbstractExtractor(ABC):
    @abstractmethod
    def extract(self, source: str) -> List[RawContent]:
        """Extract content from source"""

    @abstractmethod
    def get_supported_sources(self) -> List[str]:
        """Return supported source types"""
```

### 3. **Chunker Interface**

```python
class AbstractChunker(ABC):
    @abstractmethod
    def chunk(self, raw_content: List[RawContent]) -> List[ContentChunk]:
        """Convert raw content to chunks"""

    @abstractmethod
    def get_supported_content_types(self) -> List[ContentType]:
        """Return supported content types"""
```

## 🚀 Workflow Commands

### Content Extraction

```bash
# Extract web rules
python main.py extract rules --source https://24hoursoflemons.com/prices-rules/

# Extract diagrams from PDF
python main.py extract diagrams --source inspection-pdf-url

# Extract checklists
python main.py extract checklists --source checklist-source
```

### Content Processing

```bash
# Process all raw content into chunks
python main.py process all

# Process specific content type
python main.py process rules --strategy hierarchical
python main.py process diagrams --strategy topic-based

# Generate embeddings
python main.py embed all
python main.py embed --content-type diagrams --model clip
```

### Querying

```bash
# Query specific content types
python main.py query "roll cage requirements" --include-diagrams
python main.py query "budget limits" --content-type rules
python main.py query "safety checklist" --include-checklists

# Multimodal query
python main.py query "fuel system setup" --multimodal
```
